name: deploy-web-server

on: 
    push:
        branches:
        - node_docker_nginx

jobs:
    deploy: 
        name: deploy in droplet 
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2
      
            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
                
            - name: Make sure droplet active and running
              run: |
                doctl compute droplet list --format PublicIPv4 | awk 'NR==2 && $1!="68.183.215.151" {exit}'

            - name: Deploy to server droplet
              run: | 
                echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key
                ssh -i private_key root@68.183.215.151 '
                    cd docker-nginx && 
                    get fetch --all && 
                    git reset --hard origin/node_docker_nginx &&
                    git pull origin node_docker_nginx &&
                    docker-compose up -d --build
                '
